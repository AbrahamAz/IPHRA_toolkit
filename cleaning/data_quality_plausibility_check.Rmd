---
title: "Data quality and plausibility Report"
subtitle: "`r strings['dataset.name.short']`"
output: html_document
---

<style>
.tocify-subheader {
  font-size: 0.7em;
}
.tocify-item {
  font-size: 0.85em;
  padding-left: 25px;
  text-indent: 0;
}
</style>

```{r logo, echo=FALSE}
htmltools::img(src = knitr::image_uri("resources/Logo_Reach_RGB_1.png"), 
               alt = "REACH logo",
               style = 'position:absolute; top:0; right:0; padding:0; margin:20; width:250px')
```

```{r setup, include=FALSE}
  knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
  options(scipen = 999)
  rm(list=ls()[!ls() %in% c( "strings","params")])
  
  source("src/init_quality_checks.R")
  source("src/functions_phu.R")
  
  ## reading data 
  raw.main <- data.list$main
  raw.hh_roster <- data.list$hh_roster
  raw.ind_health <- data.list$ind_health
  raw.water_count_loop <- data.list$water_count_loop
  raw.child_nutrition <- data.list$child_nutrition
  raw.women <- data.list$women
  raw.died_member <- data.list$died_member
  
```

# {.tabset .tabset-fade}

## Introduction

### What is this tool?
The Data Quality and Plausibility Report serves as a crucial tool for assessing the reliability and accuracy of the IPHRA data collection across different sectors such as Nutrition, Mortality, Water, Sanitation and Hygiene (WASH), Food Security, and Livelihoods. This comprehensive analysis is designed to identify and address potential issues within the data, ensuring that field teams are being informed on potential issues detected in the data collection.

For each of these sectors, the report provides a detailed examination of the datasets, employing a variety of metrics and methodologies to evaluate data quality and plausibility. This includes checks for completeness, consistency, and accuracy of the data collected. This report aims to uncover any discrepancies, outliers, or anomalies that may suggest data collection, entry errors, or underlying issues that could impact the integrity of the findings.

### What is in this tool?

#### METADATA CHECK SECTION

This section provides a summary of some key findings as well as some metadata checks such as the number of <strong>UUID duplicates</strong>, <strong>outliers in survey durations/soft duplicates</strong>, and <strong> inconsistencies between loop rosters and the main datasets.</strong>

This section includes as well a map that shows the geo locations of the assessed households. 

#### FSL SECTION

This section includes:

- Overall Plausibility Report / By Enumerator
- All the flags related to Food Security and Livelihoods (details shown for each flag in the section)
- Plots showing the distribution of the data.

#### MUAC/NUTRITION SECTION

This section includes:

- Overall Plausibility Report / By Enumerator
- All the flags related to MUAC and Nutrition (details shown for each flag in the section)
- Plots showing the distribution of the data.

#### WATER CONSUMPTION SECTION

This section includes:

- All the flags related to WASH (details shown for each flag in the section)

#### MORTALITY SECTION

This section includes:

- Overall Plausibility Report / By Enumerator
- All the flags related to MORTALITY (details shown for each flag in the section)
- Plots showing the distribution of the data.

### What to do next?

Please check each flag and the <strong>ACTION</strong> related to it and act accordingly. 

Another output will be associated to this HTML, the Excel file of the flags that were fired and requires follow-up with the field team. Please check the README tab in the excel file. This file will again be generated with the full data during the cleaning of the dataset. So please do use this file during data collection and relate to it in the final one to be filled. 

### Feedback

Feedback on improvements to this product can be done through reaching out to:

- abraham.azar@impact-initiatives.org
- impact.geneva.phu@impact-initiatives.org


## METADATA CHECK

### Quick Demographic Distribution

<h5>Number of assessed Households:<strong> `r nrow(raw.main)`</strong></h5>

<h5>Number of reported Individuals:<strong> `r nrow(raw.hh_roster)`</strong></h5>

### Map of submissions locations

```{r}
location_columns <- c("_household_geopoint_latitude",
                   "_household_geopoint_longitude")

if(all(location_columns %in% names(raw.main))){
  location_data <- raw.main %>% 
    dplyr::select(enumerator, location_columns) %>% 
    rename(lat = "_household_geopoint_latitude",
           long = "_household_geopoint_longitude") %>% 
    mutate_at(vars(c(lat,long)), as.numeric)%>% 
    st_as_sf(coords = c("long","lat"), crs = 4326)
  
   map <- leaflet::leaflet() %>% 
    leaflet::addTiles() %>% 
    leaflet::addCircleMarkers(
      data = location_data,
      fillColor = "#EE5858",
      fillOpacity = 0.8,
      stroke = T,
      color = "#e1e1e1",
      weight= 1,
      radius = 4,
      popup = ~ location_data$enumerator
    ) 
   map
}
```

<h5>Number of respondent with no consent:<strong> `r nrow(raw.main %>% filter(respondent_consent == "no"))` (`r round((nrow(raw.main %>% filter(respondent_consent == "no"))/nrow(raw.main))*100,2)`% of the total assessed respondents)</strong></h5>

```{r, include = FALSE}
#-------------------------------------------------------------------------------
# 1) NO CONSENT + DUPLICATES --> deletion log
################################################################################
# check for duplicates 
ids <- raw.main$uuid[duplicated(raw.main$uuid)]
#-------------------------------------------------------------------------------
# 2) AUDIT CHECKS
################################################################################
data.audit <- raw.main %>% 
  mutate(duration_mins = abs(difftime(as.POSIXct(ymd_hms(end)), as.POSIXct(ymd_hms(start)), units = 'mins')),
         num_NA_cols = rowSums(is.na(raw.main)),
         num_dk_cols = rowSums(raw.main == "dont_know", na.rm = T),
         num_other_cols = rowSums(!is.na(raw.main[str_ends(colnames(raw.main), "_other")]), na.rm = T))%>% 
  relocate(uuid, duration_mins, num_NA_cols, num_dk_cols, num_other_cols) %>% 
  arrange(duration_mins)

survey_durations_check <- data.audit %>% filter(duration_mins < 5 | duration_mins > 60)

## Survey Duration
if(nrow(survey_durations_check) > 0){
  survey_durations_check <- survey_durations_check %>% 
    select(uuid,enum_colname,duration_mins,start, end) %>% 
    mutate(reason = ifelse(duration_mins < 5, "Submission time less than 10 mins","Submission time more than 60 mins"))
}

## Soft Duplicates
res.soft_duplicates <- find.similar.surveys(raw.main %>% filter(respondent_consent != "no"), tool.survey, uuid = "uuid") %>% 
  filter(number_different_columns <= 12)

if(nrow(res.soft_duplicates) > 0){
  res.soft_duplicates <- res.soft_duplicates %>% 
    select(uuid,enum_colname,`_id_most_similar_survey`,num_different_columns) 
}

## Loop inconsistency
# hh_roster
counts_loop1 <- raw.hh_roster %>%
  group_by(uuid) %>%
  summarize(loop_count = n())

loop_counts_main_1 <- raw.main %>% select(uuid, !!sym(enum_colname), num_hh) %>% left_join(counts_loop1) %>%
  mutate(main_count = ifelse(num_hh == "999", NA, as.numeric(num_hh)),
         reason = "hh_roster loops count not matching with num_hh",
         variable = "num_hh")%>%
  filter(loop_count %!=na% (main_count)) %>% 
  select(uuid, enum_colname,variable, main_count,loop_count, reason)

# ind_health
counts_loop2 <- raw.ind_health %>%
  group_by(uuid) %>%
  summarize(loop_count = n())

loop_counts_main_2 <- raw.main %>% select(uuid, !!sym(enum_colname), num_hh) %>% left_join(counts_loop2) %>%
  mutate(main_count = ifelse(num_hh == "999", NA, as.numeric(num_hh)),
         reason = "ind_health loops count not matching with num_hh",
         variable = "num_hh")%>%
  filter(loop_count %!=na% (main_count)) %>% 
  select(uuid, enum_colname,variable, main_count,loop_count, reason)


# water_count_loop
counts_loop3 <- raw.water_count_loop %>%
  group_by(uuid) %>%
  summarize(loop_count = n())

loop_counts_main_3 <- raw.main %>% select(uuid, !!sym(enum_colname), num_containers) %>% left_join(counts_loop3) %>%
  mutate(main_count = ifelse(num_containers == "999", NA, as.numeric(num_containers)),
         reason = "water_count_loop loops count not matching with num_containers",
         variable = "num_containers")%>%
  filter(loop_count %!=na% (main_count))%>% 
  select(uuid, enum_colname,variable, main_count,loop_count, reason)

# child_nutrition
counts_loop4 <- raw.child_nutrition %>%
  group_by(uuid) %>%
  summarize(loop_count = n())

loop_counts_main_4 <- raw.main %>% select(uuid, !!sym(enum_colname), num_hh) %>% left_join(counts_loop4) %>%
  mutate(main_count = ifelse(num_hh == "999", NA, as.numeric(num_hh)),
         reason = "child_nutrition loops count not matching with num_hh",
         variable = "num_hh")%>%
  filter(loop_count %!=na% (main_count))%>% 
  select(uuid, enum_colname,variable, main_count,loop_count, reason)

# women
if(!is.null(raw.women)){
  counts_loop5 <- raw.women %>%
    group_by(uuid) %>%
    summarize(loop_count = n())
  
  loop_counts_main_5 <- raw.main %>% select(uuid, !!sym(enum_colname), num_hh) %>% left_join(counts_loop5) %>%
    mutate(main_count = ifelse(num_hh == "999", NA, as.numeric(num_hh)),
           reason = "women loops count not matching with num_hh",
           variable = "num_hh")%>%
    filter(loop_count %!=na% (main_count))%>% 
    select(uuid, enum_colname,variable, main_count,loop_count, reason)
}

if(!is.null(raw.died_member)){
  # died_member
  counts_loop6 <- raw.died_member %>%
    group_by(uuid) %>%
    summarize(loop_count = n())
  
  loop_counts_main_6 <- raw.main %>% select(uuid, !!sym(enum_colname), num_died) %>% left_join(counts_loop6) %>%
    mutate(main_count = ifelse(num_died == "999", NA, as.numeric(num_died)),
           reason = "died_member loops count not matching with num_died",
           variable = "num_died")%>%
    filter(loop_count %!=na% (main_count))%>% 
    select(uuid, enum_colname,variable, main_count,loop_count, reason)

}
```

### Duplicates/Survey Duration/Soft Duplicates

<h5>Number of detected UUID duplicates:<strong> `r length(ids)`</strong></h5>

<h5>Number of detected outliers in survey durations:<strong> `r nrow(survey_durations_check)`</strong></h5>

```{r, results='asis'}
if(nrow(survey_durations_check) > 0){
  subch(datatable(survey_durations_check, option = tableFormat))
}
```

<h5>Number of detected outliers in soft duplicates between submission:<strong> `r nrow(res.soft_duplicates)`</strong></h5>

```{r, results='asis'}
if(nrow(res.soft_duplicates) > 0){
  subch(datatable(res.soft_duplicates, option = tableFormat))
}
```

### Inconsistency between loops and main

<h5>Number of detected inconsistency between main and hh_roster:<strong> `r nrow(loop_counts_main_1)`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_1) > 0){
  subch(datatable(loop_counts_main_1, option = tableFormat))
}
```

<h5>Number of detected inconsistency between main and ind_health:<strong> `r nrow(loop_counts_main_2)`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_2) > 0){
  subch(datatable(loop_counts_main_2, option = tableFormat))
}
```

<h5>Number of detected inconsistency between main and water_count_loop:<strong> `r nrow(loop_counts_main_3)`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_3) > 0){
  subch(datatable(loop_counts_main_3, option = tableFormat))
}
```

<h5>Number of detected inconsistency between main and child_nutrition:<strong> `r nrow(loop_counts_main_4)`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_4) > 0){
  subch(datatable(loop_counts_main_4, option = tableFormat))
}
```

<h5>Number of detected inconsistency between main and women:<strong> `r if(exists('loop_counts_main_5')) nrow(loop_counts_main_5) else 0`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_5) > 0){
  subch(datatable(loop_counts_main_5, option = tableFormat))
}
```

<h5>Number of detected inconsistency between main and died_member:<strong> `r if(exists('loop_counts_main_6')) nrow(loop_counts_main_6) else 0`</strong></h5>

```{r, results='asis'}
if(nrow(loop_counts_main_6) > 0){
  subch(datatable(loop_counts_main_6, option = tableFormat))
}
```

## FSL {.tabset .tabset-fade}

```{r, echo=FALSE, warning=FALSE,include=FALSE}
fcs_check_columns <- c("fcs_cereal",
                 "fcs_legumes",
                 "fcs_veg",
                 "fcs_fruit",
                 "fcs_meat",
                 "fcs_dairy",
                 "fcs_sugar",
                 "fcs_oil")

if(all(fcs_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_fcs_new(cutoffs = "normal")
}

rcsi_check_columns <- c("rcsi_lessquality",
                        "rcsi_borrow",
                        "rcsi_mealsize",
                        "rcsi_mealadult",
                        "rcsi_mealnb")

if(all(fcs_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_rcsi_new()
}

hhs_check_columns <- c("hhs_nofoodhh",
                       "hhs_nofoodhh_freq",
                       "hhs_sleephungry",
                       "hhs_sleephungry_freq",
                       "hhs_alldaynight",
                       "hhs_alldaynight_freq")

if(all(hhs_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_hhs_new()
}

lcsi_check_columns <- c("lcsi_stress1","lcsi_stress2","lcsi_stress3","lcsi_stress4",
                        "lcsi_crisis1","lcsi_crisis2","lcsi_crisis3",
                        "lcsi_emergency1","lcsi_emergency2","lcsi_emergency3")

if(all(lcsi_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_lcsi_new()
}

hdds_check_columns <- c("hdds_cereals","hdds_tubers","hdds_veg","hdds_fruit","hdds_meat",
                        "hdds_eggs","hdds_fish","hdds_legumes","hdds_dairy","hdds_oil",
                        "hdds_sugar","hdds_condiments")

if(all(hdds_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_hdds_new()
}

fcm_check_1_columns <- c("fcs_cat",
                         "rcsi_cat")

fcm_check_2_columns <- c("hdds_cat",
                         "rcsi_cat")

fcm_check_3_columns <- c("fcs_cat",
                         "hhs_cat")

fcm_check_4_columns <- c("hdds_cat",
                         "hhs_cat")

fcm_check_5_columns <- c("hdds_cat",
                         "rcsi_cat",
                         "hhs_cat")

fcm_check_6_columns <- c("fcs_cat",
                         "rcsi_cat",
                         "hhs_cat")



if(all(fcm_check_1_columns %in% names(raw.main)) |
   all(fcm_check_2_columns %in% names(raw.main)) |
   all(fcm_check_3_columns %in% names(raw.main)) |
   all(fcm_check_4_columns %in% names(raw.main)) |
   all(fcm_check_5_columns %in% names(raw.main)) |
   all(fcm_check_6_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_fcm_phase_new()
}

fclcm_check_columns <- c("fc_phase",
                         "lcsi_cat")
if(all(fclcm_check_columns %in% names(raw.main))) {
  raw.main <- raw.main %>% 
    add_fclcm_phase_new()
}

## FCS
raw.flag.fcs <- raw.main %>% 
  check_fs_flags(date_dc_date = "start")
```

```{r, include = FALSE}
overall_fsl_plaus <- openxlsx::read.xlsx("resources/overall_plaus.xlsx",fillMergedCells = TRUE, sheet = "FSL") %>% 
  distinct()
result <- create_fsl_quality_report_iphra(raw.flag.fcs)
result_fsl_enum <- create_fsl_quality_report_iphra(raw.flag.fcs, grouping = "enumerator")
result_pivot <- result %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(cols = everything(),names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))
bind <- data.frame(`Indicator Score` = c("plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs",
                                         "plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs","plaus_fcs",
                                         "plaus_rcsi","plaus_rcsi","plaus_rcsi","plaus_rcsi","plaus_rcsi",
                                         "plaus_rcsi","plaus_rcsi","plaus_rcsi","plaus_rcsi","plaus_rcsi",
                                         "plaus_hhs","plaus_hhs",
                                         "plaus_lcsi","plaus_lcsi","plaus_lcsi","plaus_lcsi","plaus_lcsi",
                                         "plaus_lcsi","plaus_lcsi","plaus_lcsi","plaus_lcsi","plaus_lcsi",
                                         "plaus_other_fsl","plaus_other_fsl","plaus_other_fsl",
                                         "plaus_other_fsl","plaus_other_fsl","plaus_other_fsl",
                                         "plaus_other_fsl","plaus_other_fsl","plaus_other_fsl",
                                         "plaus_other_fsl","plaus_other_fsl","plaus_other_fsl",NA,NA))
overall_fsl_plaus_overall <- overall_fsl_plaus%>% 
  left_join(result_pivot, by = c("flag_name"="Criteria")) %>% 
  mutate_all(., ~ifelse(is.na(.),"NA",.)) %>% 
  cbind(bind)%>% 
  left_join(result_pivot %>% filter(Criteria %in% c("plaus_other_fsl",
                                                    "plaus_lcsi",
                                                    "plaus_hhs",
                                                    "plaus_rcsi",
                                                    "plaus_fcs")) %>% 
              rename(indscore = "Score"), by = c("Indicator.Score"="Criteria")) %>% 
  mutate(indscore = case_when(flag_name == "plaus_flag_severe_hhs"~paste0(indscore,"/10"),
                              TRUE ~paste0(indscore,"/20"))) %>% 
  select(-Indicator.Score)
fsl <- flextable(overall_fsl_plaus_overall)


final_table <- create_table_fsl(fsl)

```

### Data Quality FSL {.tabset .tabset-fade}

#### Plausbility {.tabset .tabset-fade}

##### Overall

```{r}
final_table
```

```{r, results='asis'}
result_fsl_pivot <- result_fsl_enum %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(-enumerator,names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))
list_enum <- result_fsl_pivot$enumerator %>% unique
list_flex_enum <- list()
for (i in list_enum) {

  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",5), collapse=""), " ", "<strong>",i,"</strong>"))
  overall_fsl_plaus_enum <- overall_fsl_plaus %>% 
    left_join(result_fsl_pivot %>% filter(enumerator == i), by = c("flag_name"="Criteria"))%>% 
    mutate_all(., ~ifelse(is.na(.),"NA",.)) %>% 
    cbind(bind) %>% 
    select(-enumerator) %>% 
    left_join(result_fsl_pivot %>% 
                filter(enumerator == i) %>% 
                filter(Criteria %in% c("plaus_other_fsl",
                                       "plaus_lcsi",
                                       "plaus_hhs",
                                       "plaus_rcsi",
                                       "plaus_fcs")) %>% 
              rename(indscore = "Score"), by = c("Indicator.Score"="Criteria")) %>% 
    mutate(indscore = case_when(flag_name == "plaus_flag_severe_hhs"~paste0(indscore,"/10"),
                              TRUE ~paste0(indscore,"/20"))) %>% 
    select(-c(Indicator.Score,enumerator)) 

  fsl_enum <- flextable(overall_fsl_plaus_enum)

  final_table_fsl_enum <- create_table_fsl(fsl_enum)
  subch(final_table_fsl_enum)
  list_flex_enum <- append(list_flex_enum,final_table_fsl_enum)
}

```


```{r, results='asis'}
flag_description <- readxl::read_excel("resources/flag_description.xlsx", sheet = "FSL")
flags_fsl_columns <- names(raw.flag.fcs)[str_starts(names(raw.flag.fcs),"flag_")]
overall_flag <- tibble()
for(flag in flags_fsl_columns) {

  flag_overall <- raw.flag.fcs %>% 
    select(enumerator, !!rlang::sym(flag)) %>% 
    filter(!is.na(!!rlang::sym(flag))) %>% 
    mutate(flag := flag) %>% 
    group_by(flag) %>% 
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>% 
    mutate(percentage_flaggged = paste0(round((flagged/num_samples)*100,2),"%")) %>% 
    ungroup()
  if(nrow(flag_overall)>0){
    overall_flag <- rbind(overall_flag,flag_overall)
  }
}
add_to_html.title("Overall Flag Table")
subch(datatable(overall_flag, 
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50), 
                                      c('All')),
                    paging = T)))

for(flag in flags_fsl_columns) {
  flag_rational <- flag_description %>% 
    filter(flag_name %in% flag) %>% 
    pull(Rationale)
  flag_action <- flag_description %>% 
    filter(flag_name %in% flag) %>% 
    pull(Action)
  flag_by_enum <- raw.flag.fcs %>% 
    select(enumerator, !!rlang::sym(flag)) %>% 
    filter(!is.na(!!rlang::sym(flag))) %>% 
    mutate(flag := flag) %>% 
    group_by(flag,enumerator) %>% 
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>% 
    mutate(percentage_flagged = paste0(round((flagged/num_samples)*100,2),"%")) %>% 
    ungroup() %>% 
    select(-1)
  if(nrow(flag_by_enum)>0){
    add_to_html.title(flag)
    cat("\n")
    cat(paste("<em><strong>Rational</strong>: ",flag_rational,"</em>\n"))
    if(!is.null(flag_action)){
      cat("\n")
      cat(paste("<em><strong>Action</strong>: ",flag_action,"</em>\n"))
    }
    subch(datatable(flag_by_enum, 
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50), 
                                      c('All')),
                    paging = T)))
  }
}

```

### Plots {.tabset .tabset-fade}
  
#### FCS Ridge Overall Distribution Plot

```{r}

(plot_ridge_distribution(raw.flag.fcs, numeric_cols = c("fcs_cereal", "fcs_dairy", "fcs_veg", "fcs_fruit", "fcs_legumes", "fcs_sugar", "fcs_oil"),
                         name_groups = "Food Groups", name_units = "Days"))

```


#### FCS Ridge by Enumerator Distribution Plot

```{r}
(plot_ridge_distribution(raw.flag.fcs, numeric_cols = c("fcs_cereal", "fcs_dairy", "fcs_veg", "fcs_fruit", "fcs_legumes", "fcs_sugar", "fcs_oil"),
                         name_groups = "Food Groups", name_units = "Days", grouping = "enumerator"))
```

#### RCSI Ridge Overall Distribution Plot

```{r}
(plot_ridge_distribution(raw.flag.fcs, numeric_cols = c("rcsi_lessquality", "rcsi_borrow", "rcsi_mealsize","rcsi_mealadult", "rcsi_mealnb"),
                         name_groups = "Food Coping Strategy", name_units = "Days"))
```

#### RCSI Ridge by Enumerator Distribution Plot

```{r}
(plot_ridge_distribution(raw.flag.fcs, numeric_cols = c("rcsi_lessquality", "rcsi_borrow", "rcsi_mealsize","rcsi_mealadult", "rcsi_mealnb"),
                         name_groups = "Food Coping Strategy", name_units = "Days", grouping = "enumerator"))
```

#### FCS/RCSI/HHS Correlation Plot

```{r}
(plot_correlogram(raw.flag.fcs, numeric_cols = c("fcs_score",  "rcsi_score",  "hhs_score")))
```


## MUAC/NUTRITION {.tabset .tabset-fade}


```{r, include = FALSE}
raw.flag.nut <- raw.child_nutrition %>% 
  check_nut_flags() %>% 
  left_join(select(raw.main, c(uuid,enumerator))) 

result_nut <- create_anthro_quality_report_iphra(raw.flag.nut)
result_nut_enum <- create_anthro_quality_report_iphra(raw.flag.nut, grouping = "enumerator")
```

```{r, include = FALSE}
overall_nut_plaus <- openxlsx::read.xlsx("resources/overall_plaus.xlsx",fillMergedCells = TRUE, sheet = "NUT") %>% 
  distinct()

result_nut_pivot <- result_nut %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(cols = everything(),names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))

overall_nut_plaus_overall <- overall_nut_plaus%>% 
  left_join(result_nut_pivot, by = c("flag_name"="Criteria")) %>% 
  mutate_all(., ~ifelse(is.na(.),"NA",.)) 

nut <- flextable(overall_nut_plaus_overall)

final_table_nut <- create_table_nut(nut)
```

### Data Quality NUT {.tabset .tabset-fade}

#### Plausbility {.tabset .tabset-fade}

##### Overall

```{r}
final_table_nut
```

```{r, results='asis'}
result_nut_pivot <- result_nut_enum %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(-enumerator,names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))
list_enum <- result_nut_pivot$enumerator %>% unique
list_flex_enum <- list()
for (i in list_enum) {
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",5), collapse=""), " ", "<strong>",i,"</strong>"))
  overall_nut_plaus_enum <- overall_nut_plaus %>% 
    left_join(result_nut_pivot %>% filter(enumerator == i), by = c("flag_name"="Criteria")) %>% 
    mutate_all(., ~ifelse(is.na(.),"NA",.)) %>% 
    select(-enumerator)

  nut <- flextable(overall_nut_plaus_enum)

  final_table_nut_enum <- create_table_nut(nut)
  subch(final_table_nut_enum)
  list_flex_enum <- append(list_flex_enum,final_table_nut_enum)
}

```



```{r, results='asis'}
flag_description <- readxl::read_excel("resources/flag_description.xlsx", sheet = "NUT")
flags_nut_columns <- names(raw.flag.nut)[str_starts(names(raw.flag.nut),"flag_")]

overall_flag <- tibble()
for(flag in flags_nut_columns) {

  flag_overall <- raw.flag.nut %>%
    select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    mutate(flag := flag) %>%
    group_by(flag) %>%
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    mutate(percentage_flaggged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    ungroup()
  if(nrow(flag_overall)>0){
    overall_flag <- rbind(overall_flag,flag_overall)
  }
}
add_to_html.title("Overall Flag Table")
subch(datatable(overall_flag,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))

for(flag in flags_nut_columns) {
  flag_rational <- flag_description %>%
    filter(flag_name %in% flag) %>%
    pull(Rationale)
  flag_action <- flag_description %>%
    filter(flag_name %in% flag) %>%
    pull(Action)
  flag_by_enum <- raw.flag.nut %>%
    select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    mutate(flag := flag) %>%
    group_by(flag,enumerator) %>%
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    mutate(percentage_flagged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    ungroup() %>%
    select(-1)
  if(nrow(flag_by_enum)>0){
    add_to_html.title(flag)
    cat("\n")
    cat(paste("<em><strong>Rational</strong>: ",flag_rational,"</em>\n"))
    if(!is.null(flag_action)){
      cat("\n")
      cat(paste("<em><strong>Action</strong>: ",flag_action,"</em>\n"))
    }
    subch(datatable(flag_by_enum,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))
  }
}

```

### Plots {.tabset .tabset-fade}
  
#### Age Month Distribution

```{r}
(plot_age_months_distribution(raw.flag.nut))
```

#### Age Month Distribution per Enumerator

```{r}
(plot_age_months_distribution(raw.flag.nut, by_group = "enumerator"))
```

#### Age Distribution Anthro

```{r}
(plot_anthro_age_distribution_iphra(df = raw.flag.nut, index = "mfaz"))
```

#### Cumulative Distribution MUAC without Flag

```{r}
(plot_cumulative_distribution(df = raw.flag.nut, index = "muac", flags = "no"))
```


#### Cumulative Distribution MUAC with Flag per Enumerator

```{r}
(plot_cumulative_distribution(df = raw.flag.nut, index = "muac", flags = "yes", grouping = "enumerator"))
```

## WATER CONSUMPTION {.tabset .tabset-fade}


```{r, include = FALSE}
raw.flag.wash <- raw.main %>% 
  check_WASH_flags(raw.water_count_loop, date_dc_date = "start") 
```

```{r, results='asis'}
flag_wash_description <- readxl::read_excel("resources/flag_description.xlsx", sheet = "WASH")
flags_wash_columns <- names(raw.flag.wash)[str_starts(names(raw.flag.wash),"flag_")]
overall_flag <- tibble()
for(flag in flags_wash_columns) {

  flag_overall <- raw.flag.wash %>% 
    select(enumerator, !!rlang::sym(flag)) %>% 
    filter(!is.na(!!rlang::sym(flag))) %>% 
    mutate(flag := flag) %>% 
    group_by(flag) %>% 
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>% 
    mutate(percentage_flaggged = paste0(round((flagged/num_samples)*100,2),"%")) %>% 
    ungroup()
  if(nrow(flag_overall)>0){
    overall_flag <- rbind(overall_flag,flag_overall)
  }
}
cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "<strong>Overall Flag Table</strong>"))
subch(datatable(overall_flag, 
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50), 
                                      c('All')),
                    paging = T)))

for(flag in flags_wash_columns) {
  flag_rational <- flag_wash_description %>% 
    filter(flag_name %in% flag) %>% 
    pull(Rationale)
  flag_action <- flag_wash_description %>% 
    filter(flag_name %in% flag) %>% 
    pull(Action)
  flag_by_enum <- raw.flag.wash %>% 
    select(enumerator, !!rlang::sym(flag)) %>% 
    filter(!is.na(!!rlang::sym(flag))) %>% 
    mutate(flag := flag) %>% 
    group_by(flag,enumerator) %>% 
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>% 
    mutate(percentage_flagged = paste0(round((flagged/num_samples)*100,2),"%")) %>% 
    ungroup() %>% 
    select(-1)
  if(nrow(flag_by_enum)>0){
    cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",3), collapse=""), " ", "<strong>",flag,"</strong>"))
    cat("\n")
    cat(paste("<em><strong>Rational</strong>: ",flag_rational,"</em>\n"))
    if(!is.null(flag_action)){
      cat("\n")
      cat(paste("<em><strong>Action</strong>: ",flag_action,"</em>\n"))
    }
    subch(datatable(flag_by_enum, 
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50), 
                                      c('All')),
                    paging = T)))
  }
}

```

## MORTALITY {.tabset .tabset-fade}

```{r}
raw.mort.flags <- check_mortality_flags(raw.main,
                                        raw.hh_roster,
                                        raw.died_member)

results_mort <- create_mortality_quality_report_iphra(raw.mort.flags$crude,
                                                     raw.mort.flags$ratios)

results_mort_enum <- create_mortality_quality_report_iphra(raw.mort.flags$crude,
                                                     raw.mort.flags$ratios,
                                                     grouping = "enumerator")
```

```{r, include = FALSE}
overall_mort_plaus <- openxlsx::read.xlsx("resources/overall_plaus.xlsx",fillMergedCells = TRUE, sheet = "MORT") %>% 
  distinct()

result_mort_pivot <- results_mort %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(cols = everything(),names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))

overall_mort_plaus_overall <- overall_mort_plaus%>% 
  left_join(result_mort_pivot, by = c("flag_name"="Criteria")) %>% 
  mutate_all(., ~ifelse(is.na(.),"NA",.)) 

mort <- flextable(overall_mort_plaus_overall)

final_table_mort <- create_table_nut(mort)
```


### Data Quality MORT {.tabset .tabset-fade}

#### Plausbility {.tabset .tabset-fade}

##### Overall

```{r}
final_table_mort
```


```{r, results='asis'}
result_mort_pivot_enum <- results_mort_enum %>% 
  mutate_all(., as.character) %>% 
  pivot_longer(-enumerator,names_to = "Criteria",
               values_to = "Score") %>% 
  filter(str_starts(Criteria,"plaus_"))
list_enum <- results_mort_enum$enumerator %>% unique
list_flex_enum <- list()
for (i in list_enum) {
  cat(paste0(paste0(rep("\n",2), collapse=""), paste0(rep("#",5), collapse=""), " ", "<strong>",i,"</strong>"))
  overall_mort_plaus_enum <- overall_mort_plaus %>% 
    left_join(result_mort_pivot_enum %>% filter(enumerator == i), by = c("flag_name"="Criteria")) %>% 
    mutate_all(., ~ifelse(is.na(.),"NA",.)) %>% 
    select(-enumerator)

  mort <- flextable(overall_mort_plaus_enum)

  final_table_mort_enum <- create_table_nut(mort)
  subch(final_table_mort_enum)
  list_flex_enum <- append(list_flex_enum,final_table_mort_enum)
}

```

```{r, results='asis'}
flag_description <- readxl::read_excel("resources/flag_description.xlsx", sheet = "MORT")
cause_join <- raw.mort.flags$ratios %>% 
  group_by(uuid) %>% 
  summarise(flag_cause_death = sum(flag_cause_death, na.rm = T)) %>% 
  dplyr::mutate(flag_cause_death = ifelse(flag_cause_death>0,1,0))
raw.flag.mort <- raw.mort.flags$crude %>% 
  dplyr::left_join(select(cause_join, c(uuid, flag_cause_death)), by ="uuid")

flags_mort_columns <- names(raw.flag.mort)[str_starts(names(raw.flag.mort),"flag_")]

overall_flag <- tibble()

for(flag in flags_mort_columns) {
  flag_overall <- raw.flag.mort %>%
    select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    mutate(flag := flag) %>%
    group_by(flag) %>%
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    mutate(percentage_flaggged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    ungroup()
  if(nrow(flag_overall)>0){
    overall_flag <- rbind(overall_flag,flag_overall)
  }
}
add_to_html.title("Overall Flag Table")
subch(datatable(overall_flag,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))

for(flag in flags_mort_columns) {
  flag_rational <- flag_description %>%
    filter(flag_name %in% flag) %>%
    pull(Rationale)
  flag_action <- flag_description %>%
    filter(flag_name %in% flag) %>%
    pull(Action)
  flag_by_enum <- raw.flag.mort %>%
    select(enumerator, !!rlang::sym(flag)) %>%
    filter(!is.na(!!rlang::sym(flag))) %>%
    mutate(flag := flag) %>%
    group_by(flag,enumerator) %>%
    summarise(num_samples = n(),
              flagged = sum(!!rlang::sym(flag))) %>%
    mutate(percentage_flagged = paste0(round((flagged/num_samples)*100,2),"%")) %>%
    ungroup() %>%
    select(-1)
  if(nrow(flag_by_enum)>0){
    add_to_html.title(flag)
    cat("\n")
    cat(paste("<em><strong>Rational</strong>: ",flag_rational,"</em>\n"))
    if(!is.null(flag_action)){
      cat("\n")
      cat(paste("<em><strong>Action</strong>: ",flag_action,"</em>\n"))
    }
    subch(datatable(flag_by_enum,
                  extensions = 'Buttons', options = list(
                    dom = 'Blfrtip',
                    buttons = c('copy', 'csv', 'excel', 'pdf'),
                    lengthMenu = list(c(50),
                                      c('All')),
                    paging = T)))
  }
}

```


```{r, include=FALSE}
table_age_pyramide <- raw.hh_roster %>% 
    dplyr::mutate(age_group = cut(as.numeric(calc_final_age_years), 
                                  breaks = c(-1,4,9,14,19,24,29,34,39,44,49,54,59,64,69,74,79,84, Inf),
                                   labels = c("0-4", "5-9", "10-14", "15-19",
                                              "20-24", "25-29", "30-34", "35-39","40-44", "45-49", "50-54", "55-59",
                                              "60-64", "65-69", "70-74", "75-79", "80-84", "85+"))) %>% 
    rename(sex = "ind_sex")
```


### Plots {.tabset .tabset-fade}
  
#### Age Group / Sex Distribution

```{r}
(plot_agepyramid(table_age_pyramide))
```

#### Age Years Distibution (0 - 10)

```{r}
(plot_age_years_distribution(table_age_pyramide %>% rename(age_years = "ind_age_years") %>% 
                               mutate(age_years = as.numeric(age_years)), min_age = 0, max_age = 10))
```



```{r}
## CREATE FILE for Enumerators to keep track of changes

# 4B) FLAG Logical Checks

checks_followups <- tibble()

## FSL
# Check number 1
if("flag_protein_rcsi" %in% names(raw.flag.fcs)){
  check_protein_rcsi <- raw.flag.fcs %>% 
    select(uuid,enum_colname, flag_protein_rcsi)%>% 
    filter(flag_protein_rcsi == 1) %>% 
    left_join(raw.main %>% select(uuid, rcsi_score, fcs_meat, fcs_dairy))
  
  if(nrow(check_protein_rcsi)>0){
    checks_followups <- rbind(checks_followups,
                              make.logical.check.entry(check_protein_rcsi, 1,  c("rcsi_score","fcs_meat","fcs_dairy"), 
                                                       cols_to_keep = c(enum_colname),"rCSI Score is high while protein consumption is also reported as frequent", F))
  }
}

if("flag_lcsi_coherence" %in% names(raw.flag.fcs)){
  # Check number 2
  check_lcsi_coherence <- raw.flag.fcs %>% 
    select(uuid,enum_colname, flag_lcsi_coherence)%>% 
    filter(flag_lcsi_coherence == 1)%>% 
    left_join(raw.main %>% select(uuid, lcsi_emergency, lcsi_stress, lcsi_crisis,
                                  lcsi_stress1,lcsi_stress2,lcsi_stress3,lcsi_stress4,
                                  lcsi_crisis1,lcsi_crisis2,lcsi_crisis3,
                                  lcsi_emergency1,lcsi_emergency2,lcsi_emergency3))
  
  if(nrow(check_lcsi_coherence)>0){
    checks_followups <- rbind(checks_followups,
                              make.logical.check.entry(check_lcsi_coherence, 2,  c("lcsi_emergency", "lcsi_stress","lcsi_crisis",
                                                                                   "lcsi_stress1","lcsi_stress2","lcsi_stress3","lcsi_stress4",
                                                                                   "lcsi_crisis1","lcsi_crisis2","lcsi_crisis3",
                                                                                   "lcsi_emergency1","lcsi_emergency2","lcsi_emergency3"), # to provide all teh strategies
                                                       cols_to_keep = c(enum_colname),"HHs report using crisis or emergency strategies but not stress strategies or Emergency and no crisis.", F))
  }
}
#Check number 3
fcs_flag_columns <- c("fcs_cereal","fcs_legumes","fcs_dairy","fcs_meat","fcs_veg",
                      "fcs_fruit","fcs_oil","fcs_sugar","fcs_score")
rcsi_flag_columns <- c("rcsi_lessquality","rcsi_borrow",
                       "rcsi_mealsize","rcsi_mealadult","rcsi_mealnb","rcsi_score")

if("flag_fcsrcsi_box" %in% names(raw.flag.fcs)) {
  check_fcsrcsi_box <- raw.flag.fcs %>% 
    select(uuid,enum_colname, flag_fcsrcsi_box)%>% 
    filter(flag_fcsrcsi_box == 1)%>% 
    left_join(raw.main %>% select(uuid, fcs_flag_columns, rcsi_flag_columns))
  
  if(nrow(check_fcsrcsi_box)>0){
    checks_followups <- rbind(checks_followups,
                              make.logical.check.entry(check_fcsrcsi_box, 3,  c(fcs_flag_columns, rcsi_flag_columns), 
                                                       cols_to_keep = c(enum_colname),"HH that would have an acceptable FCS score and a high rCSI score", F))
  }
}
## WATER CONSUMPTION
#check number 4
if("flag_no_container" %in% names(raw.flag.wash)) {
  check_no_container <- raw.flag.wash %>% 
    select(uuid,enum_colname, flag_no_container)%>% 
    filter(flag_no_container == 1)%>% 
    left_join(raw.main %>% select(uuid, num_containers, water_source))
  
  if(nrow(check_no_container)>0){
    checks_followups <- rbind(checks_followups,
                              make.logical.check.entry(check_no_container, 4,  c("num_containers", "water_source"), 
                                                       cols_to_keep = c(enum_colname),"HH reported no containers but also reports that water sources are not on premises", F))
  }
}

## Nutrition
#check number 5
if("edema_confirm" %in% names(raw.child_nutrition)){
  check_eodema <- raw.child_nutrition %>% 
    select(uuid,loop_index, edema_confirm)%>% 
    filter(edema_confirm == "yes")%>% 
    left_join(raw.main %>% select(uuid, enum_colname))
  
  if(nrow(check_eodema)>0){
    checks_followups <- bind_rows(checks_followups,
                              make.logical.check.entry(check_eodema, 5,  c("edema_confirm"), 
                                                       cols_to_keep = c(enum_colname),"Respondent reported children have oedema.", T)) %>% 
      relocate(loop_index, .before = 2)
  }
}

if(!is.null(raw.died_member)){
  ## Mortality
  #check number 6
  
  check_mortality <- raw.main %>% 
    select(uuid,enum_colname, num_died)%>% 
    filter(as.numeric(num_died) >= 2)
  
  if(nrow(check_mortality)>0){
    checks_followups <- bind_rows(checks_followups,
                                  make.logical.check.entry(check_mortality, 6,  c("num_died"), 
                                                           cols_to_keep = c(enum_colname),"Respondent reported more than 2 death in the HH", F))
  }
  #check number 7
  
  check_cause_death <- raw.died_member %>% 
    select(uuid,loop_index, sex_died, cause_death)%>% 
    filter(sex_died == "m" & cause_death %in% c("post_partum","during_pregnancy","during_delivery"))%>% 
    left_join(raw.main %>% select(uuid, enum_colname))
    
  
  if(nrow(check_cause_death)>0){
    checks_followups <- bind_rows(checks_followups,
                                  make.logical.check.entry(check_cause_death, 7,  c("sex_died","cause_death"), 
                                                           cols_to_keep = c(enum_colname),"Respondent reported sex of dead person male and a cause of death related to female only.", T)) %>% 
      relocate(loop_index, .before = 2)
  }
}

checks_followups <- checks_followups %>% 
  dplyr::mutate(loops_to_remove = NA) %>% 
  dplyr::relocate(loops_to_remove, .before = "explanation")

create.follow.up.requests.daily(checks_followups,loop_data = raw.died_member, paste0("output/quality_report/",strings['dataset.name.short'],"_followup_requests_",strings['out_date'],".xlsx"), use_template = F)

```


